<%
  const activePage = 'posts';
  const title = 'All Posts | BlogSphere';
%>

<!-- Header Section -->
<div class="page-header text-center mb-5">
  <div class="header-content">
    <h1 class="display-3 mb-3">All Stories</h1>
    <p class="lead text-muted">Discover all the thoughts, stories, and ideas from our community</p>
  </div>
</div>

<div class="container">
  <!-- Stats and Filters -->
  <div class="action-bar card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2 class="h4 mb-1">
            <i class="fas fa-books me-2"></i>Community Library
          </h2>
          <p class="text-muted mb-0">
            <%= posts.length %> stories and counting
          </p>
        </div>
        <div class="col-md-6">
          <div class="d-flex flex-wrap gap-3 justify-content-md-end">
            <div class="search-container">
              <input type="text" class="form-control search-input" placeholder="Search stories...">
              <i class="fas fa-search search-icon"></i>
            </div>
            <a href="/posts/new" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>New Story
            </a>
          </div>
        </div>
      </div>
      
      <!-- Advanced Filters -->
      <div class="advanced-filters mt-4">
        <div class="row g-3">
          <div class="col-md-3">
            <select class="form-select" id="sortSelect">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="title">Title A-Z</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="categorySelect">
              <option value="all">All Categories</option>
              <option value="technology">Technology</option>
              <option value="lifestyle">Lifestyle</option>
              <option value="personal">Personal</option>
              <option value="creative">Creative</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control" id="dateFrom" placeholder="From date">
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control" id="dateTo" placeholder="To date">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner text-center py-5" id="loadingSpinner" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3">Loading stories...</p>
  </div>

  <% if (posts.length === 0) { %>
    <!-- Empty State -->
    <div class="empty-state card text-center py-5">
      <div class="card-body">
        <div class="empty-state-icon mb-4">
          <i class="fas fa-book-open fa-3x text-muted"></i>
        </div>
        <h3 class="h4 mb-3">No Stories Yet</h3>
        <p class="text-muted mb-4">
          Be the first to share your story and inspire others in our community.
        </p>
        <a href="/posts/new" class="btn btn-primary btn-lg">
          <i class="fas fa-pen-fancy me-2"></i>Write First Story
        </a>
      </div>
    </div>
  <% } else { %>
    <!-- Posts Grid/List View -->
    <div class="view-controls mb-4">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary active" id="gridViewBtn">
          <i class="fas fa-th-large"></i>
        </button>
        <button type="button" class="btn btn-outline-secondary" id="listViewBtn">
          <i class="fas fa-list"></i>
        </button>
      </div>
      <div class="view-stats text-muted small">
        Showing <span id="showingCount"><%= posts.length %></span> of <span id="totalCount"><%= posts.length %></span> stories
      </div>
    </div>

    <!-- Grid View -->
    <div class="row g-4" id="postsGrid">
      <% posts.forEach((post, index) => { %>
        <div class="col-12 col-md-6 col-lg-4 post-card" data-category="general" data-date="<%= post.createdAt.toISOString() %>">
          <article class="card h-100 post-card">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <span class="badge bg-light text-dark">
                  <i class="fas fa-tag me-1"></i>General
                </span>
                <span class="reading-time text-muted small">
                  <i class="far fa-clock me-1"></i>
                  <span class="reading-time-text"><%= Math.ceil(post.content.split(/\s+/).length / 200) %> min</span>
                </span>
              </div>
              <h3 class="card-title"><%= post.title %></h3>
              <p class="card-text flex-grow-1">
                <%= post.content.length > 120 ? post.content.substring(0, 120) + '…' : post.content %>
              </p>
              <div class="post-card-footer mt-auto pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center text-muted small mb-2">
                  <span class="d-flex align-items-center">
                    <i class="fas fa-user-circle me-1"></i>
                    <strong><%= post.author %></strong>
                  </span>
                  <time class="d-flex align-items-center">
                    <i class="far fa-calendar me-1"></i>
                    <%= post.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                  </time>
                </div>
                <div class="d-flex gap-2">
                  <a href="/posts/<%= post._id %>" class="btn btn-sm btn-outline-primary flex-fill">
                    <i class="fas fa-book-open me-1"></i>Read
                  </a>
                  <a href="/posts/<%= post._id %>/edit" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                  </a>
                </div>
              </div>
            </div>
          </article>
        </div>
      <% }); %>
    </div>

    <!-- List View (Hidden by default) -->
    <div class="list-view" id="postsList" style="display: none;">
      <% posts.forEach((post, index) => { %>
        <article class="card list-post-card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-center mb-2">
                  <span class="badge bg-light text-dark me-3">
                    <i class="fas fa-tag me-1"></i>General
                  </span>
                  <span class="text-muted small">
                    <i class="far fa-clock me-1"></i>
                    <%= Math.ceil(post.content.split(/\s+/).length / 200) %> min read
                  </span>
                </div>
                <h3 class="h5 mb-2"><%= post.title %></h3>
                <p class="text-muted mb-2">
                  <%= post.content.length > 200 ? post.content.substring(0, 200) + '…' : post.content %>
                </p>
                <div class="d-flex align-items-center text-muted small">
                  <span class="d-flex align-items-center me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    <%= post.author %>
                  </span>
                  <time class="d-flex align-items-center">
                    <i class="far fa-calendar me-1"></i>
                    <%= post.createdAt.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
                  </time>
                </div>
              </div>
              <div class="col-md-4 text-md-end">
                <div class="d-flex gap-2 justify-content-md-end">
                  <a href="/posts/<%= post._id %>" class="btn btn-outline-primary">
                    <i class="fas fa-book-open me-1"></i>Read Story
                  </a>
                  <a href="/posts/<%= post._id %>/edit" class="btn btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </article>
      <% }); %>
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-5">
      <button class="btn btn-outline-secondary" id="loadMoreBtn">
        <i class="fas fa-redo me-2"></i>Load More Stories
      </button>
    </div>
  <% } %>
</div>

<style>
  .page-header {
    background: linear-gradient(135deg, var(--light-color) 0%, var(--light-gray) 100%);
    border-bottom: 1px solid var(--border-color);
    padding: 4rem 0;
  }

  .header-content {
    max-width: 600px;
    margin: 0 auto;
  }

  .advanced-filters {
    background: var(--light-gray);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-top: 1.5rem;
  }

  .view-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-color);
  }

  .view-stats {
    font-weight: 500;
  }

  .list-post-card {
    transition: var(--transition);
  }

  .list-post-card:hover {
    border-color: var(--accent-color);
    transform: translateX(5px);
  }

  .list-post-card .card-body {
    padding: 1.5rem 2rem;
  }

  /* Animation for view switching */
  .view-switch {
    animation: fadeInUp 0.5s ease;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .page-header {
      padding: 3rem 0;
    }
    
    .display-3 {
      font-size: 2rem;
    }
    
    .list-post-card .card-body {
      padding: 1.25rem;
    }
    
    .list-post-card .row > div:last-child {
      margin-top: 1rem;
    }
    
    .view-controls {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // View toggle functionality
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const postsGrid = document.getElementById('postsGrid');
    const postsList = document.getElementById('postsList');

    gridViewBtn.addEventListener('click', function() {
      gridViewBtn.classList.add('active');
      listViewBtn.classList.remove('active');
      postsGrid.style.display = 'flex';
      postsList.style.display = 'none';
      postsGrid.classList.add('view-switch');
      setTimeout(() => postsGrid.classList.remove('view-switch'), 500);
    });

    listViewBtn.addEventListener('click', function() {
      listViewBtn.classList.add('active');
      gridViewBtn.classList.remove('active');
      postsGrid.style.display = 'none';
      postsList.style.display = 'block';
      postsList.classList.add('view-switch');
      setTimeout(() => postsList.classList.remove('view-switch'), 500);
    });

    // Search functionality
    const searchInput = document.querySelector('.search-input');
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const postCards = document.querySelectorAll('.post-card, .list-post-card');
      let visibleCount = 0;

      postCards.forEach(card => {
        const title = card.querySelector('.card-title, .h5').textContent.toLowerCase();
        const content = card.querySelector('.card-text, .text-muted').textContent.toLowerCase();
        const author = card.querySelector('strong').textContent.toLowerCase();

        if (title.includes(searchTerm) || content.includes(searchTerm) || author.includes(searchTerm)) {
          card.style.display = card.classList.contains('list-post-card') ? 'block' : 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      document.getElementById('showingCount').textContent = visibleCount;
    });

    // Sort functionality
    const sortSelect = document.getElementById('sortSelect');
    sortSelect.addEventListener('change', function() {
      const sortBy = this.value;
      const postCards = Array.from(document.querySelectorAll('.post-card'));
      
      postCards.sort((a, b) => {
        if (sortBy === 'newest') {
          return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
        } else if (sortBy === 'oldest') {
          return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
        } else if (sortBy === 'title') {
          const titleA = a.querySelector('.card-title').textContent.toLowerCase();
          const titleB = b.querySelector('.card-title').textContent.toLowerCase();
          return titleA.localeCompare(titleB);
        }
        return 0;
      });

      // Reappend sorted cards
      const gridContainer = document.getElementById('postsGrid');
      postCards.forEach(card => gridContainer.appendChild(card));
    });

    // Load more functionality (simulated)
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
        this.disabled = true;
        
        setTimeout(() => {
          showToast('No more stories to load', 'info');
          this.innerHTML = '<i class="fas fa-check me-2"></i>All Stories Loaded';
        }, 1500);
      });
    }

    // Filter by date
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');

    [dateFrom, dateTo].forEach(input => {
      input.addEventListener('change', filterByDate);
    });

    function filterByDate() {
      const fromDate = dateFrom.value ? new Date(dateFrom.value) : null;
      const toDate = dateTo.value ? new Date(dateTo.value) : null;
      const postCards = document.querySelectorAll('.post-card');
      let visibleCount = 0;

      postCards.forEach(card => {
        const postDate = new Date(card.getAttribute('data-date'));
        let shouldShow = true;

        if (fromDate && postDate < fromDate) {
          shouldShow = false;
        }
        if (toDate && postDate > toDate) {
          shouldShow = false;
        }

        card.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });

      document.getElementById('showingCount').textContent = visibleCount;
    }
  });
</script>